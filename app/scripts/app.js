var app=angular.module("myApp",["ngRoute","ngStorage","geolocation","Home","Login","User","Match"]);app.value("apiUrl","http://121.41.22.78/time_new/"),app.value("apiKey","test-key"),app.value("apiAppkey","82hegw5uh918x"),app.run(["$rootScope","$location","LoginService",function(a,b,c){a.$on("$routeChangeStart",function(a,d,e){c.getLoginState().success(function(a,c){console.log(a),"FAIL"==a.return_code||"FAIL"==a.result_code?b.path("/login").replace():console.log("登录没有异常")})})}]),app.factory("apiTime",function(){function a(){var a=new Date,b=parseInt(a.getTime()/1e3);return b}return{run:function(){return a()}}}).factory("apiToken",function(){function a(a,b){var c=[],d="";for(var e in a)c.push(e);c.sort(),console.log(c);for(var f=0;f<c.length;f++)d=d+""+a[c[f]];return console.log(d),d+""+b}return{run:function(b,c){return a(b,c)}}}).factory("apiLocal",["geolocation",function(a){var b=function(){var a="android";return a};return{run:function(){return b()}}}]).factory("apiMd5",function(){function a(a){var b,d,e,f,g,o,p,q,r,s=Array(),t=7,u=12,v=17,w=22,x=5,y=9,z=14,A=20,B=4,C=11,D=16,E=23,F=6,G=10,H=15,I=21;for(a=n(a),s=l(a),o=1732584193,p=4023233417,q=2562383102,r=271733878,b=0;b<s.length;b+=16)d=o,e=p,f=q,g=r,o=h(o,p,q,r,s[b+0],t,3614090360),r=h(r,o,p,q,s[b+1],u,3905402710),q=h(q,r,o,p,s[b+2],v,606105819),p=h(p,q,r,o,s[b+3],w,3250441966),o=h(o,p,q,r,s[b+4],t,4118548399),r=h(r,o,p,q,s[b+5],u,1200080426),q=h(q,r,o,p,s[b+6],v,2821735955),p=h(p,q,r,o,s[b+7],w,4249261313),o=h(o,p,q,r,s[b+8],t,1770035416),r=h(r,o,p,q,s[b+9],u,2336552879),q=h(q,r,o,p,s[b+10],v,4294925233),p=h(p,q,r,o,s[b+11],w,2304563134),o=h(o,p,q,r,s[b+12],t,1804603682),r=h(r,o,p,q,s[b+13],u,4254626195),q=h(q,r,o,p,s[b+14],v,2792965006),p=h(p,q,r,o,s[b+15],w,1236535329),o=i(o,p,q,r,s[b+1],x,4129170786),r=i(r,o,p,q,s[b+6],y,3225465664),q=i(q,r,o,p,s[b+11],z,643717713),p=i(p,q,r,o,s[b+0],A,3921069994),o=i(o,p,q,r,s[b+5],x,3593408605),r=i(r,o,p,q,s[b+10],y,38016083),q=i(q,r,o,p,s[b+15],z,3634488961),p=i(p,q,r,o,s[b+4],A,3889429448),o=i(o,p,q,r,s[b+9],x,568446438),r=i(r,o,p,q,s[b+14],y,3275163606),q=i(q,r,o,p,s[b+3],z,4107603335),p=i(p,q,r,o,s[b+8],A,1163531501),o=i(o,p,q,r,s[b+13],x,2850285829),r=i(r,o,p,q,s[b+2],y,4243563512),q=i(q,r,o,p,s[b+7],z,1735328473),p=i(p,q,r,o,s[b+12],A,2368359562),o=j(o,p,q,r,s[b+5],B,4294588738),r=j(r,o,p,q,s[b+8],C,2272392833),q=j(q,r,o,p,s[b+11],D,1839030562),p=j(p,q,r,o,s[b+14],E,4259657740),o=j(o,p,q,r,s[b+1],B,2763975236),r=j(r,o,p,q,s[b+4],C,1272893353),q=j(q,r,o,p,s[b+7],D,4139469664),p=j(p,q,r,o,s[b+10],E,3200236656),o=j(o,p,q,r,s[b+13],B,681279174),r=j(r,o,p,q,s[b+0],C,3936430074),q=j(q,r,o,p,s[b+3],D,3572445317),p=j(p,q,r,o,s[b+6],E,76029189),o=j(o,p,q,r,s[b+9],B,3654602809),r=j(r,o,p,q,s[b+12],C,3873151461),q=j(q,r,o,p,s[b+15],D,530742520),p=j(p,q,r,o,s[b+2],E,3299628645),o=k(o,p,q,r,s[b+0],F,4096336452),r=k(r,o,p,q,s[b+7],G,1126891415),q=k(q,r,o,p,s[b+14],H,2878612391),p=k(p,q,r,o,s[b+5],I,4237533241),o=k(o,p,q,r,s[b+12],F,1700485571),r=k(r,o,p,q,s[b+3],G,2399980690),q=k(q,r,o,p,s[b+10],H,4293915773),p=k(p,q,r,o,s[b+1],I,2240044497),o=k(o,p,q,r,s[b+8],F,1873313359),r=k(r,o,p,q,s[b+15],G,4264355552),q=k(q,r,o,p,s[b+6],H,2734768916),p=k(p,q,r,o,s[b+13],I,1309151649),o=k(o,p,q,r,s[b+4],F,4149444226),r=k(r,o,p,q,s[b+11],G,3174756917),q=k(q,r,o,p,s[b+2],H,718787259),p=k(p,q,r,o,s[b+9],I,3951481745),o=c(o,d),p=c(p,e),q=c(q,f),r=c(r,g);var J=m(o)+m(p)+m(q)+m(r);return J.toLowerCase()}function b(a,b){return a<<b|a>>>32-b}function c(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f}function d(a,b,c){return a&b|~a&c}function e(a,b,c){return a&c|b&~c}function f(a,b,c){return a^b^c}function g(a,b,c){return b^(a|~c)}function h(a,e,f,g,h,i,j){return a=c(a,c(c(d(e,f,g),h),j)),c(b(a,i),e)}function i(a,d,f,g,h,i,j){return a=c(a,c(c(e(d,f,g),h),j)),c(b(a,i),d)}function j(a,d,e,g,h,i,j){return a=c(a,c(c(f(d,e,g),h),j)),c(b(a,i),d)}function k(a,d,e,f,h,i,j){return a=c(a,c(c(g(d,e,f),h),j)),c(b(a,i),d)}function l(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=Array(f-1),h=0,i=0;c>i;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}function m(a){var b,c,d="",e="";for(c=0;3>=c;c++)b=a>>>8*c&255,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d}function n(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}return{run:function(b){return a(b)}}}),app.directive("focus",function(){return{link:function(a,b,c){b[0].focus()}}}),app.controller("MainController",["$scope","$rootScope","$localStorage",function(a,b,c){c.$default({local:null,loginkey:null,phone:null,rctoken:null,user:null}),console.log(c),b.coords={longitude:"1.1",latitude:"1.1"}}]),app.config(["$routeProvider",function(a){a.when("/",{controller:"HomeController",templateUrl:"./modules/Home/views/home.html"}).when("/login",{controller:"LoginController",templateUrl:"./modules/Login/views/login.html"}).when("/login/info",{controller:"LoginInfoController",templateUrl:"./modules/Login/views/login-info.html"}).when("/user",{controller:"UserController",templateUrl:"./modules/User/views/user.html"}).when("/user/set",{controller:"UserSetController",templateUrl:"./modules/User/views/userSet.html"}).when("/user/set/info",{controller:"UserSetInfoController",templateUrl:"./modules/User/views/userSetInfo.html"}).when("/user/set/identify",{controller:"UserSetIdentifyController",templateUrl:"./modules/User/views/userSetIdentify.html"}).when("/match",{controller:"MatchController",templateUrl:"./modules/Match/views/match.html"}).when("/chat",{controller:"ChatController",templateUrl:"./modules/Match/views/chat.html"}).otherwise({redirectTo:"/"})}]);var appHome=angular.module("Home",["ngStorage","ngAnimate"]);appHome.controller("HomeController",["$scope",function(a){a.chooseTag=function(){},a.chooseSex=function(){},a.changeSex=function(){},a.clearAll=function(){},a.match=function(){}}]),appHome.directive("myChoosetag",["$timeout","$rootScope","$location","HomeService","geolocation",function(a,b,c,d,e){return{link:function(e,f,g,h){function j(a){a||(a=0),step=6-a,angular.forEach(o,function(b,c){0!=c&&(i=(c-1+step)%6,a==c-1?(l(o[c]).css({transform:"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 ) scale3d(1.5,1.5,1)","-webkit-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 ) scale3d(1.5,1.5,1)","-moz-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 ) scale3d(1.5,1.5,1)","-o-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 ) scale3d(1.5,1.5,1)","-ms-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 ) scale3d(1.5,1.5,1)"}),l(o[c]).addClass("active")):(l(o[c]).css({transform:"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 )","-webkit-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 )","-moz-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 )","-o-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 )","-ms-transform":"translate3d("+m[i].x+"px, "+m[i].y+"px, 0 )"}),l(o[c]).removeClass("active")))})}var k="coffee";e.showCoffee=!0,e.showBook=!1,e.showChat=!1,e.showGame=!1,e.showFilm=!1,e.showKtv=!1,e.showDesc=!0,e.showSex=!1,e.sex="M";var l=angular.element,m=[{x:0,y:-228},{x:-210,y:-108},{x:-210,y:108},{x:0,y:228},{x:212,y:108},{x:212,y:-108}],n=null,o=f.children();angular.forEach(o,function(a,b){0!=b?l(o[b]).bind("click",function(){e.chooseTag(b-1),j(b-1)}):l(o[b]).bind("click",function(){e.chooseSex()})}),a(j,300),e.chooseTag=function(b){switch(e.clearAll(),b){case 0:k="coffee",a.cancel(n),n=a(function(){e.showDesc=!0,e.showCoffee=!0},300,!0);break;case 1:k="book",a.cancel(n),n=a(function(){e.showDesc=!0,e.showBook=!0},300,!0);break;case 2:k="chat",a.cancel(n),n=a(function(){e.showDesc=!0,e.showChat=!0},300,!0);break;case 3:k="game",a.cancel(n),n=a(function(){e.showDesc=!0,e.showGame=!0},300,!0);break;case 4:k="film",a.cancel(n),n=a(function(){e.showDesc=!0,e.showFilm=!0},300,!0);break;case 5:k="ktv",a.cancel(n),n=a(function(){e.showDesc=!0,e.showKtv=!0},300,!0)}},e.chooseSex=function(){e.showDesc=!1,e.$apply(),a(function(){e.showSex=!0},300,!0)},e.changeSex=function(a){"boy"==a?e.sex="M":e.sex="F"},e.clearAll=function(){e.showCoffee=!1,e.showBook=!1,e.showChat=!1,e.showGame=!1,e.showFilm=!1,e.showKtv=!1,e.showDesc=!1,e.showSex=!1,e.sex="M",e.$apply()},e.match=function(){d.startMatch(k,e.sex).success(function(a,b){console.log(a),"SUCCESS"==a.result_code&&c.path("/match")})},a.cancel(b.matchTimer),d.cancelMatch().success(function(a,b){"NO_TAG"==a.party_state&&console.log("取消tag成功")})}}}]),appHome.factory("HomeService",["$rootScope","$http","$localStorage","apiUrl","apiKey","apiTime","apiToken","apiMd5","apiLocal",function(a,b,c,d,e,f,g,h,i){var j=function(j,k){var l="App/PParty/create",m=c.loginkey,n=i.run(),o=f.run(),p=a.coords.longitude,q=a.coords.latitude,r=h.run(g.run({loginkey:m,local:n,time:o,tag_type:j,target_sex:k,longitude:p,latitude:q},e));return b({method:"JSONP",url:d+l,params:{callback:"JSON_CALLBACK",loginkey:m,local:n,time:o,tag_type:j,target_sex:k,longitude:p,latitude:q,token:r}})},k=function(){var a="App/PParty/cancel",j=c.loginkey,k=i.run(),l=f.run(),m=h.run(g.run({loginkey:j,local:k,time:l},e));return b({method:"JSONP",url:d+a,params:{callback:"JSON_CALLBACK",loginkey:j,local:k,time:l,token:m}})};return{startMatch:function(a,b){return j(a,b)},cancelMatch:function(){return k()}}}]);var appLogin=angular.module("Login",["ngStorage","ngAnimate"]);appLogin.controller("LoginController",["$scope",function(a){a.getYZM=function(){},a.submit=function(){}}]).controller("LoginInfoController",["$scope",function(a){a.changeSex=function(){},a.goPrev=function(){},a.submit=function(){}}]),appLogin.directive("myLoginform",["$timeout","$location","$localStorage","LoginService","apiLocal",function(a,b,c,d,e){return{link:function(f,g,h,i){function j(){return 0==f.offTime?(f.offTime=10,void(f.offYZM=!0)):(a(j,1e3,!0),void f.offTime--)}f.isYZM=!0,f.offYZM=!0,f.offTime=10,f.getYZM=function(){d.getYZM(f.user.phone).success(function(a,b){console.log(a)}),f.offYZM=!1,a(j,1e3,!0)},f.submit=function(){d.sendYZM(f.user.phone,f.user.yzm).success(function(a,d){console.log(a),"SUCCESS"==a.result_code?(c.local=e.run(),c.loginkey=a.loginkey,c.phone=f.user.phone,c.rctoken=a.rc_token,a.user.username?b.path("/"):b.path("/login/info")):f.isYZM=!1})}}}}]).directive("myLogininfoform",["$location","$localStorage","$filter","LoginService",function(a,b,c,d){return{link:function(e,f,g,h){e.user={sex:"M"},e.changeSex=function(a){"boy"==a?e.user.sex="M":e.user.sex="F"},e.goPrev=function(){a.path("/login")},e.submit=function(){var f=c("date")(e.user.birth,"yyyy-MM-dd");d.updateInfo(e.user.name,e.user.sex,f).success(function(c,d){"SUCCESS"==c.result_code&&(b.user={headimg:c.user.headimg,username:c.user.username,sex:c.user.sex,birthday:c.user.birthday},a.path("/").replace())})}}}}]),appLogin.factory("LoginService",["$http","$localStorage","apiUrl","apiKey","apiTime","apiToken","apiMd5","apiLocal",function(a,b,c,d,e,f,g,h){var i=function(b){var h="App/PSystem/send_login_messagecode",i=e.run(),j=g.run(f.run({phone:b,time:i},d));return a({method:"JSONP",url:c+h,params:{callback:"JSON_CALLBACK",phone:b,time:i,token:j}})},j=function(b,i){var j="App/PSystem/messagecode_login",k=h.run(),l=e.run(),m=g.run(f.run({phone:b,local:k,code:i,time:l},d));return a({method:"JSONP",url:c+j,params:{callback:"JSON_CALLBACK",phone:b,local:k,code:i,time:l,token:m}})},k=function(i,j,k){var l="App/PUser/update",m=b.loginkey,n=h.run(),o=e.run(),p="timer",q=g.run(f.run({loginkey:m,local:n,time:o,username:i,realname:p,sex:j,birthday:k},d));return a({method:"JSONP",url:c+l,params:{callback:"JSON_CALLBACK",loginkey:m,local:n,time:o,username:i,realname:p,sex:j,birthday:k,token:q}})},l=function(){var i="App/PSystem/is_login",j=b.loginkey,k=h.run(),l=e.run(),m=g.run(f.run({loginkey:j,local:k,time:l},d));return a({method:"JSONP",url:c+i,params:{callback:"JSON_CALLBACK",loginkey:j,local:k,time:l,token:m}})};return{getYZM:function(a){return i(a)},sendYZM:function(a,b){return j(a,b)},updateInfo:function(a,b,c){return k(a,b,c)},getLoginState:function(){return l()}}}]);var appMatch=angular.module("Match",["ngStorage"]);appMatch.controller("MatchController",["$scope",function(a){a.second=0,a.cancelMatch=function(){}}]).controller("ChatController",["$scope",function(a){a.cancelChat=function(){},a.send=function(){}}]),appMatch.directive("myMatch",["$timeout","$location","$rootScope","$location","MatchService",function(a,b,c,b,d){return{link:function(e,f,g,h){function i(){1==e.second?b.path("/"):d.getMatchState().success(function(a,d){console.log(a),"PARTY_START"==a.party_state&&(c.partyUser=a.party_user,b.path("/chat").replace())}),e.second--,c.matchTimer=a(i,1e3,!0)}e.second=600,a(i,1e3,!0),e.cancelMatch=function(){b.path("/").replace()}}}}]).directive("myChat",["$timeout","$rootScope","$location","$localStorage","MatchService","apiAppkey",function(a,b,c,d,e,f){return{link:function(g,h,i,j){$=angular.element;var k=$(h).children()[1],l=$(k).children()[0];RongIMClient.init(f),RongIMClient.setConnectionStatusListener({onChanged:function(a){console.log(a.toString(),new Date)}});var m=null,n=null;RongIMClient.getInstance().setOnReceiveMessageListener({onReceived:function(a){var b=$("<div></div>");$(b).addClass("message receive"),"M"==m.sex?$(b).html("<span>												<img src='./modules/Match/images/chat-boy.png'>											</span>											<p>"+a.getContent()+"</p>"):$(b).html("<span>												<img src='./modules/Match/images/chat-girl.png'>											</span>											<p>"+a.getContent()+"</p>"),$(l).append(b),$(h)[0].scrollTop=$(h)[0].scrollHeight-$(h)[0].offsetHeight}});var o="";RongIMClient.connect(d.rctoken,{onSuccess:function(a){console.log("connected，userid＝"+a),b.partyUser[0].userid==a?(o=b.partyUser[1].userid,m=b.partyUser[1],n=b.partyUser[0]):(o=b.partyUser[0].userid,m=b.partyUser[0],n=b.partyUser[1])},onError:function(a){}}),g.send=function(){var a=RongIMClient.ConversationType.setValue("4"),b=g.sendCont,c=$("<div></div>");$(c).addClass("message send"),"M"==n.sex?$(c).html("<p>"+b+"</p>										<span>											<img src='./modules/Match/images/chat-boy.png' >										</span>"):$(c).html("<p>"+b+"</p>										<span>											<img src='./modules/Match/images/chat-girl.png'>										</span>"),$(l).append(c),$(h)[0].scrollTop=$(h)[0].scrollHeight-$(h)[0].offsetHeight,g.sendCont="",RongIMClient.getInstance().sendMessage(a,o,RongIMClient.TextMessage.obtain(b),null,{onSuccess:function(){console.log("send successfully")},onError:function(){console.log("send fail")}})},g.cancelChat=function(){e.cancelMatch().success(function(a,b){"NO_TAG"==a.party_state&&c.path("/").replace()})},a.cancel(b.matchTimer),a(function(){p()},1e3);var p=function(){e.getMatchState().success(function(a,b){"ASSEMBLING"==a.party_state&&g.cancelChat()}),b.matchTimer=a(p,1e3)}}}}]),appMatch.factory("MatchService",["$http","$localStorage","apiUrl","apiKey","apiTime","apiToken","apiMd5","apiLocal",function(a,b,c,d,e,f,g,h){var i=function(){var i="App/PParty/cancel",j=b.loginkey,k=h.run(),l=e.run(),m=g.run(f.run({loginkey:j,local:k,time:l},d));return a({method:"JSONP",url:c+i,params:{callback:"JSON_CALLBACK",loginkey:j,local:k,time:l,token:m}})},j=function(){var i="App/PParty/state",j=b.loginkey,k=h.run(),l=e.run(),m=g.run(f.run({loginkey:j,local:k,time:l},d));return a({method:"JSONP",url:c+i,params:{callback:"JSON_CALLBACK",loginkey:j,local:k,time:l,token:m}})};return{cancelMatch:function(){return i()},getMatchState:function(){return j()}}}]);var appUser=angular.module("User",["ngStorage"]);appUser.controller("UserController",["$scope",function(a){a.user={headimg:"./modules/User/images/user-demo.png",username:"username",sex:"M",birthday:"0000-00-00"}}]).controller("UserSetController",["$scope","$localStorage","$location",function(a,b,c){a.loginOut=function(){b.$reset(),c.path("/login")}}]).controller("UserSetInfoController",["$scope",function(a){a.user={headimg:"./modules/User/images/user-demo.png",username:"username",sex:"M",birthday:"0000-00-00"},a.changeSex=function(){},a.submit=function(){}}]).controller("UserSetIdentifyController",["$scope",function(a){}]),appUser.directive("myUserinfo",["$filter","$location","$localStorage","UserService",function(a,b,c,d){return{link:function(e,f,g,h){e.user=null==c.user?{headimg:"./modules/User/images/user-demo.png",username:"username",sex:"M",birthday:"0000-00-00"}:{headimg:c.user.headimg,username:c.user.username,sex:c.user.sex,birthday:c.user.birthday},d.getUserInfo().success(function(a,b){console.log(a),"SUCCESS"==a.result_code&&(e.user={headimg:a.headimg,username:a.username,sex:a.sex,birthday:a.birthday},c.user={headimg:a.headimg,username:a.username,sex:a.sex,birthday:a.birthday})}),e.changeSex=function(a){"boy"==a?e.user.sex="M":e.user.sex="F"},e.submit=function(){var f=a("date")(e.user.birthday,"yyyy-MM-dd");d.updateUserInfo(e.user.username,e.user.sex,f).success(function(a,d){console.log(a),"SUCCESS"==a.result_code?(c.user={headimg:a.user.headimg,username:a.user.username,sex:a.user.sex,birthday:a.user.birthday},console.log(c.user),b.path("/")):console.log("修改信息失败")})}}}}]),appUser.factory("UserService",["$http","$localStorage","apiUrl","apiKey","apiTime","apiToken","apiMd5","apiLocal",function(a,b,c,d,e,f,g,h){var i=function(){var h="App/PUser/info",i=b.loginkey,j=b.local,k=e.run(),l=g.run(f.run({loginkey:i,local:j,time:k},d));return a({method:"JSONP",url:c+h,params:{callback:"JSON_CALLBACK",loginkey:i,local:j,time:k,token:l}})},j=function(){var h="App/PUser/headimg",i=b.loginkey,j=b.local,k=e.run(),l=g.run(f.run({loginkey:i,local:j,time:k},d));return a({method:"JSONP",url:c+h,params:{callback:"JSON_CALLBACK",loginkey:i,local:j,time:k,token:l}})},k=function(i,j,k){var l="App/PUser/update",m=b.loginkey,n=h.run(),o=e.run(),p="timer",q=g.run(f.run({loginkey:m,local:n,time:o,username:i,realname:p,sex:j,birthday:k},d));return a({method:"JSONP",url:c+l,params:{callback:"JSON_CALLBACK",loginkey:m,local:n,time:o,username:i,realname:p,sex:j,birthday:k,token:q}})};return{getUserInfo:function(){return i()},getUserHeadimg:function(){return j()},updateUserInfo:function(a,b,c){return k(a,b,c)}}}]);